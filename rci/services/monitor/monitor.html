<!DOCTYPE html>
<html>
<head>
<style type=text/css>
td { border: 1px solid; }
div#elJobLog { background-color: black; color: white; font: 14pt monospace; height: 4in; overflow-y: scroll; }
div#elJobLog > p,span { margin: 0; padding: 0; }
div#elJobLog > p.err,span.err { color: red; }
div#elPanel form,ul,li{display: inline; }
div#elPanel a:hover { cursor:pointer; }
</style>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {

  var _newLine = false;
  var currentTabElement = elTabRunningJobs;
  var ws;
  var wsMsgHandlers = {
    jobInfo: function(job) {
      elJobName.innerText = job.name;
      elJobStatus.innerText = job.status;
    },
    consoleData: function(data) {
      consoleWrite(data[0], data[1]);
    },
    jobsConfigs: function(data) {
      updateStartJobForm(data);
    },
    jobStartOk: function(job) {
      alert("Started " + job);
    },
    authOk: function(auth) {
      if(auth.login !== null) {
        elLogin.style.display = "none";
        elLogout.style.display = "inline";
      } else {
        elLogin.style.display = "inline";
        elLogout.style.display = "none";
      }
    }
  };

  function sendWS(data) {
    ws.send(JSON.stringify(data));
  }

  function apiOnline() {
    bits = window.location.hash.split("/");
    if (bits[0] == "#job") {
      sendWS(["getJobInfo", [bits[1]]]);
    }
  }

  function apiOffline() {
    console.log("offline");
  }

  function connectWS() {
    ws = new WebSocket(location.protocol == 'https:' ? 'wss://' : 'ws://' + window.location.host + window.location.pathname + "api.sock");
    ws.onmessage = function(e) {
      var msg = JSON.parse(e.data);
      wsMsgHandlers[msg[0]](msg[1]);
    };
    ws.onopen = function(e) {
      apiOnline();
    };
    ws.onclose = function(e) {
      apiOffline(false);
      window.setTimeout(connectWS, 5000);
    }
  }

  function consoleWrite(line, stream) {
    var data = document.createElement(_newLine ? "p" : "span");
    if (stream == 2) {
      data.className = "err";
    }
    data.appendChild(document.createTextNode(line));
    elJobLog.appendChild(data);
  }

  function parseOutput(line, stream) {
    var lines = line.split("\n");
    var _shouldScroll = elJobLog.scrollTopMax == elJobLog.scrollTop;
    elJobLog.style.height = Math.trunc(window.innerHeight - elJobLog.getBoundingClientRect().top - 10) + "px";
    for(var i=0; i<lines.length; i++) {
      if(i>0) {
        _newLine = true;
      }
      if((i+1 == lines.length) && (lines[i] != "")) {
        _newLine = false;
      }
      if (lines[i] != "") {
        consoleWrite(lines[i], stream);
      }
    }
    if (_shouldScroll) {
      elJobLog.scrollTop = elJobLog.scrollHeight;
    }
  }

  function switchTab(element) {
    currentTabElement.style.display = "none";
    element.style.display = "block";
    currentTabElement = element;
  }

  function _createTrNameValuePair(table, name, value) {
    var tr = table.appendChild(document.createElement("tr"));
    var tdNameName = tr.appendChild(document.createElement("td"));
    var tdNameValue = tr.appendChild(document.createElement("td"));
    tdNameName.appendChild(document.createTextNode(name));
    tdNameValue.appendChild(value);
  }

  function _createScriptsMultisel(scripts) {
    var select = document.createElement("select");
    select.multiple = true;
    for(var i=0; i < scripts.length; i++) {
      var option = document.createElement("option");
      option.value = scripts[i];
      option.selected = true;
      option.appendChild(document.createTextNode(scripts[i]));
      select.appendChild(option);
    }
    return select;
  }

  function updateStartJobForm(data) {
    for(var i=0; i<data.jobs.length; i++) {
      var job = data.jobs[i];
      var table = document.createElement("table");
      _createTrNameValuePair(table, "name", document.createTextNode(job.name));
      _createTrNameValuePair(table, "provider", document.createTextNode(job.provider));
      _createTrNameValuePair(table, "cluster", document.createTextNode(job.cluster));

      button = document.createElement("button");
      button.appendChild(document.createTextNode("Start"));
      button.addEventListener("click", function () {
        sendWS(["startJob", [job.name]]);
        switchTab(elTabRunningJobs);
      });
      var tr = document.createElement("tr");
      var td = tr.appendChild(document.createElement("td"));
      td.colSpan = 2;
      td.appendChild(button);
      table.appendChild(tr);

      elTabStartJob.appendChild(table);
    }
  }

  connectWS();
  showStartJob.addEventListener("click", function() {
    sendWS(["getJobsConfigs", []]);
    switchTab(elTabStartJob);
  });
  showRunningTasks.addEventListener("click", function() {
    switchTab(elTabRunningJobs);
  });

});
</script>
</head>
<body>
<div id=elContent>

<div id=elPanel>
<form method=post action="login/github" id=elLogin style="display: none;"><input type=submit value="Login via github"></form>
<form method=post action="logout" id=elLogout style="display: none;"><input type=submit value="Logout"></form>
<ul>
  <li><a id=showRunningTasks>Running jobs</a></li>
  <li><a id=showFinishedTasks>Finished jobs</a></li>
  <li><a id=showStartJob>Start job</a></li>
</ul>
</div>

<div id=elTabJobStatus style="display: none;">
    <h1><span id=elJobName></span>[<span id=elJobStatus></span>]</h1>
  <div id=elJobLog></div>
</div>

<div id=elTabRunningJobs>
  jobs
</div>

<div id=elTabStartJob style="display: none;">
  start job
</div>

</div>
</body>
</html>
